---
inclusion: always
---

# 端口冲突处理规范

## 自动处理端口冲突

当启动服务时遇到端口被占用的情况，应该自动检测并清理占用端口的进程。

## 处理策略

### 1. 检测端口占用

在启动服务前，先检查目标端口是否被占用：

```powershell
# 检查端口占用
netstat -ano | findstr :端口号
```

### 2. 自动清理进程

如果端口被占用，自动终止占用该端口的进程：

```powershell
# 获取占用端口的进程 PID
$pids = (netstat -ano | findstr :端口号 | ForEach-Object { ($_ -split '\s+')[-1] }) | Sort-Object -Unique

# 终止进程
foreach ($pid in $pids) {
    if ($pid -and $pid -ne "0") {
        Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
    }
}
```

### 3. 批处理版本

```batch
@echo off
REM 检查并清理端口占用
for /f "tokens=5" %%a in ('netstat -ano ^| findstr :端口号') do (
    taskkill /F /PID %%a >nul 2>&1
)
```

## 项目端口配置

### 当前使用的端口

- **后端服务**: 8000 (Django)
- **前端服务**: 7500 (React)

### 端口选择原则

1. **避免使用不安全端口**: 某些浏览器（如 Chrome）将特定端口列为不安全端口，例如：
   - 6000 (X11)
   - 6665-6669 (IRC)
   - 其他系统保留端口

2. **使用常见开发端口**:
   - 3000-3999: 前端开发服务器
   - 8000-8999: 后端开发服务器
   - 5000-5999: 其他服务

3. **避免端口冲突**:
   - 检查系统中已运行的服务
   - 使用 `netstat -ano` 查看端口占用情况

## 启动脚本集成

### PowerShell 启动脚本模板

```powershell
# 清理端口函数
function Clear-Port {
    param([int]$Port)
    
    Write-Host "检查端口 $Port..." -ForegroundColor Yellow
    $portUsage = netstat -ano | findstr ":$Port"
    
    if ($portUsage) {
        Write-Host "端口 $Port 被占用，正在清理..." -ForegroundColor Yellow
        $pids = ($portUsage | ForEach-Object { ($_ -split '\s+')[-1] }) | Sort-Object -Unique
        
        foreach ($processId in $pids) {
            if ($processId -and $processId -ne "0") {
                try {
                    Stop-Process -Id $processId -Force -ErrorAction SilentlyContinue
                    Write-Host "✅ 已清理进程 PID: $processId" -ForegroundColor Green
                } catch {
                    Write-Host "⚠️  无法停止进程 $processId" -ForegroundColor Yellow
                }
            }
        }
    } else {
        Write-Host "✅ 端口 $Port 可用" -ForegroundColor Green
    }
}

# 使用示例
Clear-Port -Port 8000  # 清理后端端口
Clear-Port -Port 7500  # 清理前端端口
```

### 批处理启动脚本模板

```batch
@echo off
echo 检查并清理端口占用...

REM 清理后端端口 8000
for /f "tokens=5" %%a in ('netstat -ano ^| findstr :8000') do (
    echo 清理端口 8000 的进程 %%a
    taskkill /F /PID %%a >nul 2>&1
)

REM 清理前端端口 7500
for /f "tokens=5" %%a in ('netstat -ano ^| findstr :7500') do (
    echo 清理端口 7500 的进程 %%a
    taskkill /F /PID %%a >nul 2>&1
)

echo 端口清理完成
```

## AI 助手行为规范

当 AI 助手需要启动服务时：

1. **优先检查端口**: 在启动服务前，先检查目标端口是否被占用
2. **自动清理**: 如果端口被占用，自动执行清理命令
3. **提示用户**: 告知用户正在清理端口占用
4. **验证结果**: 清理后验证端口是否可用
5. **错误处理**: 如果清理失败，提供手动清理的命令

## 常见问题处理

### 1. 权限不足

如果遇到权限问题，提示用户：
- 以管理员身份运行脚本
- 或手动停止占用端口的进程

### 2. 进程无法停止

某些系统进程可能无法停止，建议：
- 更换端口
- 重启计算机
- 检查是否有其他服务在使用该端口

### 3. 端口仍然被占用

清理后端口仍被占用，可能原因：
- 进程正在重启
- 有多个进程占用同一端口
- 系统延迟释放端口

解决方法：
- 等待几秒后重试
- 使用 `netstat -ano | findstr :端口号` 再次检查
- 重启网络服务

## 注意事项

1. **谨慎终止进程**: 确保不会误杀重要的系统进程
2. **保存工作**: 在清理端口前，确保相关应用的工作已保存
3. **日志记录**: 记录被终止的进程信息，便于问题排查
4. **用户确认**: 对于生产环境，建议在终止进程前征得用户确认
