# Implementation Plan: 异步视频合成

## Overview

本实现计划将基于现有的视频合成代码，重构为真正的异步执行模式。主要工作包括：创建线程安全的任务管理器、进度跟踪器，以及优化现有的合成逻辑。

## Tasks

- [x] 1. 创建核心服务组件
  - 实现线程安全的任务管理和进度跟踪
  - **需求：** 1.2, 1.3, 2.1, 5.1, 5.2, 5.3
  - **优先级：** 高

---

- [x] 1.1 创建 TaskManager 单例类
  - 在 `backend/videos/` 目录下创建 `task_manager.py`
  - 实现线程安全的单例模式
  - 实现任务注册、启动、取消、查询方法
  - 使用 `threading.Lock` 保护共享数据
  - **需求：** 1.3, 5.1

- [x] 1.2 创建 ProgressTracker 类
  - 在 `backend/videos/task_manager.py` 中添加 ProgressTracker
  - 实现线程安全的进度更新方法
  - 实现进度查询方法
  - 确保进度值在 0-100 范围内且单调递增
  - **需求：** 2.2, 3.1, 3.2

- [x] 1.3 编写 TaskManager 属性测试

  - **Property 2: 任务ID唯一性**
  - **Property 8: 线程安全与资源管理**
  - **Validates: Requirements 1.2, 5.1, 5.2, 5.3**

---

- [x] 2. 重构视频合成执行逻辑
  - 优化后台线程执行和取消机制
  - **需求：** 2.1, 2.2, 2.3, 2.4, 4.1
  - **优先级：** 高

---

- [x] 2.1 重构 `run_composition_in_thread` 函数
  - 修改 `backend/videos/tasks.py`
  - 集成 TaskManager 进行状态管理
  - 添加取消检查点（每处理一个视频后检查）
  - 实现每10%进度更新
  - **需求：** 2.1, 2.2, 2.3, 2.4

- [x] 2.2 实现协作式取消机制
  - 使用 `threading.Event` 实现取消标志
  - 在合成循环中定期检查取消状态
  - 取消时正确清理临时文件
  - **需求：** 4.1

- [x] 2.3 编写状态转换属性测试

  - **Property 4: 状态转换正确性**
  - **Validates: Requirements 2.1, 2.3, 2.4**

- [x] 2.4 编写进度更新属性测试

  - **Property 5: 进度更新一致性**
  - **Validates: Requirements 2.2**

---

- [x] 3. 更新 API 视图层
  - 优化响应时间，确保异步返回
  - **需求：** 1.1, 1.4, 3.1, 3.2, 3.3, 4.2, 4.3
  - **优先级：** 高

---

- [x] 3.1 优化 `create_composition_task` 视图
  - 修改 `backend/videos/views.py`
  - 确保在 500ms 内返回响应
  - 验证视频数量（至少2个）
  - 返回唯一的任务ID
  - **需求：** 1.1, 1.2, 1.4

- [x] 3.2 优化 `composition_task_detail` 视图
  - 返回完整的进度信息
  - 当任务完成时返回输出文件信息
  - **需求：** 3.1, 3.2, 3.3

- [x] 3.3 优化 `cancel_composition_task` 视图
  - 集成 TaskManager 的取消功能
  - 验证任务状态（仅允许取消 pending/processing）
  - 拒绝已完成或已失败任务的取消请求
  - **需求：** 4.2, 4.3

- [ ]* 3.4 编写取消操作属性测试
  - **Property 7: 取消操作正确性**
  - **Validates: Requirements 4.1, 4.2, 4.3**

---

- [ ] 4. Checkpoint - 核心功能验证
  - 确保所有测试通过
  - 验证异步执行正常工作
  - 如有问题请询问用户

---

- [x] 5. 数据库连接管理优化
  - 确保后台线程正确管理数据库连接
  - **需求：** 5.2, 5.3
  - **优先级：** 中

---

- [x] 5.1 优化数据库连接处理
  - 在线程开始时关闭继承的连接
  - 在 finally 块中确保连接关闭
  - 处理连接异常情况
  - **需求：** 5.2

- [x] 5.2 实现资源清理机制
  - 异常退出时清理临时文件
  - 确保线程资源正确释放
  - **需求：** 5.3

- [x] 5.3 编写资源管理属性测试
  - **Property 8: 线程安全与资源管理（补充）**
  - **Validates: Requirements 5.2, 5.3**

---

- [x] 6. 查询功能完善
  - 完善进度查询和任务列表功能
  - **需求：** 3.1, 3.2, 3.3
  - **优先级：** 中

---

- [x] 6.1 增强进度查询响应
  - 添加预计剩余时间字段（可选）
  - 添加当前处理阶段描述
  - **需求：** 3.1, 3.2

- [x] 6.2 编写查询返回值属性测试
  - **Property 6: 查询返回值完整性**
  - **Validates: Requirements 3.1, 3.2, 3.3**

---


- [x] 7. Checkpoint - 完整功能验证
  - 确保所有测试通过
  - 验证端到端流程
  - 如有问题请询问用户

---

- [x] 8. 性能优化与监控
  - 添加性能监控和日志
  - **需求：** 1.1
  - **优先级：** 低

---

- [x] 8.1 添加响应时间监控
  - 记录 API 响应时间
  - 添加慢请求告警
  - **需求：** 1.1

- [x] 8.2 编写响应时间属性测试
  - **Property 1: 响应时间保证**
  - **Validates: Requirements 1.1**

- [x] 8.3 编写异步执行属性测试
  - **Property 3: 异步执行验证**
  - **Validates: Requirements 1.3**

---

- [ ] 9. Final Checkpoint - 全面测试
  - 运行所有单元测试和属性测试
  - 验证所有需求已满足
  - 如有问题请询问用户

## Notes

- 标记 `*` 的任务为可选测试任务，可以跳过以加快 MVP 开发
- 每个属性测试都引用了设计文档中的正确性属性
- 建议按顺序执行任务，确保依赖关系正确
- Checkpoint 任务用于阶段性验证，确保代码质量
