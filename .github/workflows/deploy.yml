name: Deploy to Production

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: []
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')
    
    environment:
      name: production
      url: https://your-domain.com

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 部署到服务器
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          cd /path/to/your/app
          git pull origin master
          
          # 更新后端
          cd backend
          source venv/bin/activate
          pip install -r requirements.txt
          python manage.py migrate
          python manage.py collectstatic --noinput
          sudo systemctl restart gunicorn
          sudo systemctl restart nginx
          
          # 更新前端
          cd ../frontend
          npm install
          npm run build
          sudo cp -r build/* /var/www/html/

  # 健康检查
  health-check:
    runs-on: ubuntu-latest
    needs: [deploy]
    
    steps:
    - name: 等待服务启动
      run: sleep 30

    - name: 检查后端健康状态
      run: |
        curl -f ${{ secrets.BACKEND_URL }}/health/ || exit 1

    - name: 检查前端可访问性
      run: |
        curl -f ${{ secrets.FRONTEND_URL }} || exit 1

    - name: 发送部署通知
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        message: |
          部署状态: ${{ job.status }}
          分支: ${{ github.ref }}
          提交: ${{ github.sha }}
          作者: ${{ github.actor }}